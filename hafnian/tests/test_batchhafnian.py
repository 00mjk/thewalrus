# Copyright 2019 Xanadu Quantum Technologies Inc.

# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at

#     http://www.apache.org/licenses/LICENSE-2.0

# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
"""Tests for the batch hafnian wrapper function"""
import pytest

import numpy as np
from hafnian import batchhafnian


def test_batchhafnian():
    """ This tests the batchhafnian wrapper function to compute photon number statistics for a given gaussian state.
	"""

    mat = np.array(
        [
            [0.920381, -0.072714, -1.141482, 0.166058],
            [-0.072714, 2.456324, 0.337705, 0.988284],
            [-1.141482, 0.337705, 2.509430, 0.072714],
            [0.166058, 0.988284, 0.072714, 0.664800],
        ]
    )
    d = np.array([1.00000, 0.38730, 0.25000, -1.54919])
    res = 4

    expected = np.array(
        [
            (1 + 0j),
            (-1.6461473614325668 - 0.6195402124414471j),
            (1.9435145627843005 + 1.6255759716236886j),
            (-1.4461862708501556 - 2.042680769864964j),
            (0.4356423680768504 - 1.072099590416856j),
            (-1.3204790605197072 + 1.3727336763577636j),
            (2.237664900555327 - 1.048557534660016j),
            (-1.869175640511 + 0.24487565879724393j),
            (-0.6769669674005948 - 0.535426992920119j),
            (0.5736703325027916 + 1.0638283060818365j),
            (-0.07331881485170588 - 1.1316743631160495j),
            (-0.12199719034023199 - 0.05508958207667192j),
            (0.23216177772096924 + 0.23383257719379813j),
            (-0.5571982286446322 - 0.3783360559626241j),
            (1.1856316384882786 + 0.7663533801993523j),
            (-1.7923587436194306 - 1.4249208389189967j),
            (-1.646147361432567 + 0.6195402124414472j),
            (3.2304716699317244 - 8.326672684688674e-17j),
            (-4.656940175077999 - 1.6414085061443975j),
            (4.444012869743004 + 3.1339166990529628j),
            (-0.046315938060701875 + 1.935886862642117j),
            (1.3107387005985383 - 3.065898108910937j),
            (-3.221772066352872 + 3.306727732689523j),
            (3.6323740533734536 - 1.862133434877784j),
            (1.239918934932034 + 0.36169504952709747j),
            (-1.442139281533666 - 1.1898901285787533j),
            (0.8010921614344039 + 1.6524090857492288j),
            (0.22856760264427933 - 0.07672004442254149j),
            (-0.6992317822147758 - 0.050957252555576676j),
            (1.5102266479625508 + 0.160560057891349j),
            (-2.916039965157133 - 0.6312160791953454j),
            (4.30125549000658 + 1.584880355106333j),
            (1.943514562784301 - 1.6255759716236895j),
            (-4.656940175078 + 1.641408506144399j),
            (8.150532384021409 - 2.0040600505999517e-15j),
            (-9.769816125550319 - 2.897154236386954j),
            (-0.7953766196596727 - 2.458197670091402j),
            (-0.30668525747105835 + 4.732702174268303j),
            (2.9990052856246177 - 6.5012668927358j),
            (-5.195762756320816 + 5.386925266040271j),
            (-1.40243197720326 + 0.13193565010128755j),
            (2.0320813390003902 + 0.6458420494487498j),
            (-1.6292947037046694 - 1.4663918832957878j),
            (-0.25051487030942804 + 0.17410530520457523j),
            (1.1288099576053772 - 0.7031144823949127j),
            (-2.6928545430333135 + 0.9823712946386932j),
            (5.339665846712019 - 0.7304753004301746j),
            (-8.002108132001908 - 0.4698771635662655j),
            (-1.4461862708501567 + 2.0426807698649654j),
            (4.444012869743005 - 3.133916699052966j),
            (-9.76981612555032 + 2.897154236386963j),
            (15.228428529775837 - 9.520052103641616e-15j),
            (1.116418133143398 + 1.8317943098112988j),
            (-0.8678341578593983 - 4.415164577222401j),
            (-1.2135682557062673 + 7.85181522030068j),
            (4.85970544316298 - 9.376067095930923j),
            (0.48238949925893965 - 0.21097463166019426j),
            (-0.9169276531981645 + 0.05271108526559958j),
            (0.919681681289782 + 0.30202796967362466j),
            (0.5206559215895475 + 0.3025377353466604j),
            (-0.8341953716758566 + 1.7350864043343437j),
            (2.9222967230268453 - 2.8434016910059814j),
            (-6.788099043273135 + 3.301111154699033j),
            (11.099678261564822 - 2.0559910749687744j),
            (0.4356423680768504 + 1.072099590416856j),
            (-0.04631593806070191 - 1.9358868626421166j),
            (-0.7953766196596718 + 2.4581976700914008j),
            (1.1164181331433962 - 1.831794309811297j),
            (1.5687765777934972 - 5.551115123125783e-17j),
            (-2.3160607704169305 - 0.9239293641715348j),
            (2.25637651213759 + 2.072520460987025j),
            (-1.0535746129214378 - 1.7234897896656904j),
            (0.4791579883727394 - 1.451327616132779j),
            (-1.448513258565365 + 1.6383731023023769j),
            (2.0061111580010986 - 0.9256311470721109j),
            (-0.5182636398408739 - 0.08651994917851896j),
            (-0.615836535559489 - 0.018025792479015257j),
            (0.5364305636982384 - 0.00495003549144124j),
            (-0.28816593631349635 + 0.7103399324688097j),
            (0.4590489084535225 - 2.213517069523804j),
            (-1.3204790605197076 - 1.3727336763577638j),
            (1.3107387005985394 + 3.065898108910938j),
            (-0.3066852574710601 - 4.732702174268302j),
            (-0.8678341578593946 + 4.415164577222402j),
            (-2.316060770416931 + 0.9239293641715354j),
            (4.159884843164345 - 6.973588373426765e-16j),
            (-5.1301506832239605 - 1.962128961121093j),
            (3.411028511841363 + 2.699231582228209j),
            (0.15534962847152278 + 2.2605116066807343j),
            (1.1266534647433262 - 3.2125126283143466j),
            (-2.551956976607554 + 2.718470652368584j),
            (1.3749613593927914 - 0.3914053800068329j),
            (0.5896077716191497 - 0.4801133201516864j),
            (-0.4948016625752937 + 0.7089133265424292j),
            (-0.07512102369068357 - 1.7709098019915128j),
            (0.5265173468929071 + 4.065999927137708j),
            (2.2376649005553277 + 1.048557534660016j),
            (-3.221772066352874 - 3.306727732689523j),
            (2.999005285624621 + 6.5012668927358j),
            (-1.2135682557062741 - 7.851815220300679j),
            (2.256376512137591 - 2.0725204609870267j),
            (-5.13015068322396 + 1.9621289611210964j),
            (8.007816900397989 - 2.1545265571631944e-15j),
            (-7.397362883086027 - 2.4672159839153878j),
            (-1.0551093731568186 - 2.2277803954555835j),
            (0.1449939714410603 + 3.998103490492172j),
            (1.8322694499636556 - 4.563720275807185j),
            (-2.2325171347303256 + 1.8152075258462859j),
            (0.206934934836024 + 0.8176673720273001j),
            (-0.6051114070403479 - 1.5186178788799112j),
            (1.5566312625280623 + 3.087503339909733j),
            (-2.6961993860520743 - 5.850752415752736j),
            (-1.8691756405110014 - 0.24487565879724454j),
            (3.632374053373456 + 1.8621334348777847j),
            (-5.195762756320825 - 5.386925266040272j),
            (4.859705443162994 + 9.376067095930917j),
            (-1.0535746129214387 + 1.7234897896656933j),
            (3.4110285118413626 - 2.699231582228213j),
            (-7.397362883086028 + 2.4672159839153958j),
            (10.389601294360096 - 8.659739592076221e-15j),
            (0.6445527230085171 + 0.7763490982051588j),
            (-0.6961684708563791 - 2.078288881157184j),
            (-0.262839606628467 + 3.6774170437420137j),
            (1.9530935251111685 - 3.396746229125138j),
            (-1.4274649252343792 + 0.001672687542994239j),
            (2.661088921340522 + 1.051747051614398j),
            (-4.019381030219859 - 3.2670598998776246j),
            (4.99610368278559 + 6.245767606553146j),
            (-0.6769669674005948 + 0.535426992920119j),
            (1.2399189349320336 - 0.36169504952709747j),
            (-1.402431977203259 - 0.13193565010128663j),
            (0.4823894992589397 + 0.21097463166019306j),
            (0.47915798837274 + 1.451327616132779j),
            (0.15534962847152198 - 2.2605116066807334j),
            (-1.0551093731568169 + 2.227780395455583j),
            (0.6445527230085142 - 0.7763490982051585j),
            (2.080270430031886 - 4.494595086059092e-16j),
            (-2.7181518910660514 - 1.1537127259352908j),
            (2.087494378610579 + 2.1438456419139573j),
            (-0.3590111192880865 - 0.7751279645634697j),
            (0.23992080656207673 - 1.6942082548284203j),
            (-1.0693252518143552 + 1.755651624688094j),
            (1.143394071019861 - 0.7871442082158908j),
            (0.925081051588596 - 0.29129771218086514j),
            (0.5736703325027916 - 1.063828306081837j),
            (-1.4421392815336662 + 1.1898901285787553j),
            (2.032081339000389 - 0.6458420494487513j),
            (-0.9169276531981663 - 0.05271108526559548j),
            (-1.4485132585653662 - 1.6383731023023769j),
            (1.1266534647433284 + 3.212512628314347j),
            (0.14499397144105616 - 3.9981034904921735j),
            (-0.6961684708563742 + 2.0782888811571834j),
            (-2.718151891066052 + 1.1537127259352928j),
            (4.452344697307414 - 2.033095913844818e-15j),
            (-4.61154260349387 - 1.935894264713223j),
            (1.741271081324826 + 1.6587700846528342j),
            (0.6253612439195081 + 2.167976561608894j),
            (0.3759155306670736 - 2.8707237034855675j),
            (-1.2187678986505852 + 1.9241342206739647j),
            (-0.5130594790184191 + 0.6633590674366242j),
            (-0.07331881485170566 + 1.13167436311605j),
            (0.8010921614344031 - 1.6524090857492302j),
            (-1.6292947037046699 + 1.4663918832957923j),
            (0.9196816812897806 - 0.3020279696736301j),
            (2.0061111580011004 + 0.9256311470721109j),
            (-2.5519569766075576 - 2.718470652368582j),
            (1.8322694499636603 + 4.563720275807182j),
            (-0.2628396066284765 - 3.6774170437420133j),
            (2.0874943786105784 - 2.14384564191396j),
            (-4.611542603493869 + 1.9358942647132293j),
            (6.559445178970863 - 3.8441472227646045e-15j),
            (-4.664205000513964 - 1.8452530210579035j),
            (-1.2853652110049416 - 1.519495888759724j),
            (0.7819451884868734 + 2.7859754451168803j),
            (0.5639693654831524 - 2.838386607397158j),
            (-0.7031673647315231 + 0.014702472595036875j),
            (-0.1219971903402316 + 0.05508958207667125j),
            (0.2285676026442791 + 0.07672004442254138j),
            (-0.2505148703094279 - 0.1741053052045809j),
            (0.520655921589551 - 0.3025377353466543j),
            (-0.5182636398408754 + 0.08651994917851916j),
            (1.3749613593927925 + 0.39140538000683145j),
            (-2.232517134730333 - 1.8152075258462856j),
            (1.9530935251111812 + 3.3967462291251347j),
            (-0.3590111192880866 + 0.7751279645634725j),
            (1.7412710813248249 - 1.658770084652839j),
            (-4.664205000513963 + 1.8452530210579128j),
            (7.362291531289198 - 8.710046572879548e-15j),
            (0.014277711091815914 + 0.053228086835117594j),
            (-0.3187712064962277 - 0.729284151487443j),
            (-0.052434196759220175 + 2.1141745707581183j),
            (1.685071629395439 - 2.582028289541217j),
            (0.23216177772096924 - 0.23383257719379813j),
            (-0.6992317822147753 + 0.050957252555576274j),
            (1.1288099576053763 + 0.7031144823949127j),
            (-0.8341953716758554 - 1.7350864043343415j),
            (-0.6158365355594885 + 0.018025792479015784j),
            (0.5896077716191488 + 0.4801133201516855j),
            (0.20693493483602293 - 0.8176673720272984j),
            (-1.4274649252343774 - 0.001672687542995932j),
            (0.23992080656207795 + 1.6942082548284205j),
            (0.625361243919506 - 2.167976561608893j),
            (-1.285365211004939 + 1.5194958887597256j),
            (0.014277711091813083 - 0.05322808683511848j),
            (2.9912365326653934 - 1.2666379446401832e-15j),
            (-3.7519547392752775 - 1.594247759317081j),
            (2.822131188690561 + 2.802689874537535j),
            (-0.7813580567970162 - 0.9628729513404694j),
            (-0.557198228644632 + 0.378336055962624j),
            (1.5102266479625492 - 0.1605600578913485j),
            (-2.6928545430333126 - 0.982371294638693j),
            (2.9222967230268426 + 2.8434016910059774j),
            (0.5364305636982384 + 0.004950035491440213j),
            (-0.4948016625752942 - 0.7089133265424263j),
            (-0.6051114070403483 + 1.5186178788799083j),
            (2.6610889213405198 - 1.0517470516143954j),
            (-1.0693252518143574 - 1.7556516246880935j),
            (0.37591553066707817 + 2.8707237034855684j),
            (0.7819451884868662 - 2.7859754451168808j),
            (-0.318771206496224 + 0.7292841514874446j),
            (-3.751954739275278 + 1.5942477593170854j),
            (6.1039316745485985 - 3.497202527569243e-15j),
            (-6.4864162249939215 - 2.6148029473196273j),
            (3.3015097812527943 + 2.5321780585282685j),
            (1.1856316384882783 - 0.7663533801993528j),
            (-2.9160399651571334 + 0.6312160791953464j),
            (5.339665846712017 + 0.7304753004301712j),
            (-6.788099043273133 - 3.301111154699028j),
            (-0.2881659363134968 - 0.7103399324688098j),
            (-0.07512102369068373 + 1.7709098019915126j),
            (1.5566312625280605 - 3.087503339909731j),
            (-4.019381030219854 + 3.2670598998776192j),
            (1.1433940710198627 + 0.7871442082158902j),
            (-1.2187678986505892 - 1.9241342206739638j),
            (0.5639693654831582 + 2.83838660739716j),
            (-0.05243419675923025 - 2.114174570758121j),
            (2.82213118869056 - 2.8026898745375393j),
            (-6.486416224993921 + 2.6148029473196366j),
            (9.989504427757229 - 6.2450045135165055e-15j),
            (-9.095705527977328 - 3.109672745533205j),
            (-1.792358743619431 + 1.4249208389189976j),
            (4.301255490006582 - 1.584880355106335j),
            (-8.00210813200191 + 0.46987716356627063j),
            (11.099678261564824 + 2.055991074968764j),
            (0.45904890845352375 + 2.213517069523805j),
            (0.5265173468929049 - 4.065999927137711j),
            (-2.6961993860520694 + 5.850752415752735j),
            (4.996103682785584 - 6.245767606553148j),
            (0.9250810515885952 + 0.291297712180864j),
            (-0.5130594790184188 - 0.6633590674366241j),
            (-0.7031673647315273 - 0.014702472595040317j),
            (1.685071629395449 + 2.582028289541217j),
            (-0.7813580567970168 + 0.9628729513404732j),
            (3.3015097812527947 - 2.5321780585282747j),
            (-9.09570552797733 + 3.1096727455332203j),
            (15.615916224079953 - 1.42559575255774e-14j),
        ]
    )

    hafs = batchhafnian(mat, d, 4)

    assert np.allclose(hafs, expected)
