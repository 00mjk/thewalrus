# Copyright 2019 Xanadu Quantum Technologies Inc.

# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at

#     http://www.apache.org/licenses/LICENSE-2.0

# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
"""Tests for the batch hafnian wrapper function"""
import pytest

import numpy as np
from hafnian import batchhafnian, hermite_multidimensional


def test_batchhafnian():
    """ This tests the batchhafnian wrapper function to compute photon number statistics for a given gaussian state.
	"""

    mat = np.array(
        [
            [0.920381, -0.072714, -1.141482, 0.166058],
            [-0.072714, 2.456324, 0.337705, 0.988284],
            [-1.141482, 0.337705, 2.509430, 0.072714],
            [0.166058, 0.988284, 0.072714, 0.664800],
        ]
    )
    d = np.array([1.00000, 0.38730, 0.25000, -1.54919])
    res = 4

    expected = np.array(
        [
            (1 + 0j),
            (-1.6461473614325666 - 0.6195402124414479j),
            (1.9435145627842987 + 1.6255759716236913j),
            (-1.4461862708501507 - 2.0426807698649676j),
            (0.43564236807685164 - 1.0720995904168564j),
            (-1.3204790605197103 + 1.3727336763577629j),
            (2.2376649005553317 - 1.048557534660012j),
            (-1.869175640511003 + 0.2448756587972366j),
            (-0.6769669674005946 - 0.5354269929201221j),
            (0.5736703325027889 + 1.063828306081842j),
            (-0.07331881485169942 - 1.1316743631160544j),
            (-0.12199719034023782 - 0.05508958207667103j),
            (0.2321617777209659 + 0.2338325771937968j),
            (-0.557198228644628 - 0.3783360559626206j),
            (1.185631638488276 + 0.7663533801993496j),
            (-1.7923587436194286 - 1.4249208389189998j),
            (-1.6461473614325666 + 0.6195402124414479j),
            (3.230471669931724 + 0j),
            (-4.656940175077998 - 1.6414085061444015j),
            (4.444012869742997 + 3.1339166990529717j),
            (-0.046315938060702805 + 1.9358868626421184j),
            (1.310738700598543 - 3.0658981089109387j),
            (-3.221772066352882 + 3.30672773268952j),
            (3.6323740533734643 - 1.8621334348777732j),
            (1.2399189349320354 + 0.3616950495271019j),
            (-1.442139281533665 - 1.189890128578763j),
            (0.8010921614343967 + 1.6524090857492415j),
            (0.22856760264429005 - 0.07672004442254832j),
            (-0.6992317822147703 - 0.05095725255557637j),
            (1.5102266479625428 + 0.16056005789134598j),
            (-2.916039965157127 - 0.6312160791953426j),
            (4.301255490006578 + 1.5848803551063386j),
            (1.9435145627842987 - 1.6255759716236913j),
            (-4.656940175077998 + 1.6414085061444015j),
            (8.150532384021409 + 1.1102230246251565e-16j),
            (-9.769816125550312 - 2.8971542363869696j),
            (-0.7953766196596732 - 2.458197670091403j),
            (-0.3066852574710616 + 4.732702174268306j),
            (2.999005285624629 - 6.501266892735803j),
            (-5.195762756320836 + 5.386925266040261j),
            (-1.402431977203263 + 0.1319356501012832j),
            (2.0320813390003933 + 0.645842049448762j),
            (-1.629294703704666 - 1.4663918832958085j),
            (-0.2505148703094409 + 0.17410530520459433j),
            (1.128809957605371 - 0.7031144823949115j),
            (-2.692854543033303 + 0.9823712946386943j),
            (5.33966584671201 - 0.7304753004301763j),
            (-8.002108132001908 - 0.4698771635662733j),
            (-1.4461862708501507 + 2.0426807698649676j),
            (4.4440128697429975 - 3.133916699052971j),
            (-9.769816125550316 + 2.8971542363869682j),
            (15.228428529775831 + 3.154201497617691e-15j),
            (1.1164181331433993 + 1.8317943098112972j),
            (-0.867834157859399 - 4.415164577222402j),
            (-1.213568255706272 + 7.851815220300688j),
            (4.859705443163003 - 9.376067095930921j),
            (0.4823894992589418 - 0.21097463166019126j),
            (-0.9169276531981689 + 0.05271108526558999j),
            (0.9196816812897842 + 0.3020279696736462j),
            (0.5206559215895542 + 0.3025377353466293j),
            (-0.8341953716758517 + 1.7350864043343435j),
            (2.9222967230268373 - 2.8434016910059827j),
            (-6.7880990432731245 + 3.3011111546990346j),
            (11.099678261564826 - 2.055991074968767j),
            (0.43564236807685164 + 1.0720995904168564j),
            (-0.04631593806070277 - 1.9358868626421184j),
            (-0.7953766196596735 + 2.458197670091403j),
            (1.1164181331434002 - 1.8317943098112965j),
            (1.568776577793499 + 5.551115123125783e-17j),
            (-2.316060770416933 - 0.9239293641715376j),
            (2.2563765121375905 + 2.0725204609870316j),
            (-1.0535746129214332 - 1.7234897896656962j),
            (0.4791579883727431 - 1.4513276161327813j),
            (-1.4485132585653733 + 1.638373102302377j),
            (2.006111158001108 - 0.9256311470721055j),
            (-0.5182636398408769 - 0.08651994917852703j),
            (-0.6158365355594884 - 0.018025792479021363j),
            (0.5364305636982337 - 0.004950035491432234j),
            (-0.28816593631348925 + 0.7103399324688051j),
            (0.4590489084535217 - 2.213517069523806j),
            (-1.3204790605197103 - 1.3727336763577629j),
            (1.310738700598543 + 3.065898108910939j),
            (-0.30668525747106057 - 4.732702174268307j),
            (-0.8678341578594013 + 4.415164577222402j),
            (-2.3160607704169336 + 0.9239293641715374j),
            (4.159884843164352 + 1.6132928326584306e-16j),
            (-5.130150683223965 - 1.9621289611211021j),
            (3.4110285118413604 + 2.699231582228223j),
            (0.15534962847151948 + 2.2605116066807387j),
            (1.1266534647433375 - 3.212512628314352j),
            (-2.5519569766075727 + 2.718470652368582j),
            (1.3749613593928045 - 0.3914053800068207j),
            (0.5896077716191513 - 0.4801133201516779j),
            (-0.4948016625752912 + 0.7089133265424145j),
            (-0.07512102369069222 - 1.7709098019915006j),
            (0.5265173468929117 + 4.065999927137709j),
            (2.2376649005553317 + 1.048557534660012j),
            (-3.221772066352882 - 3.30672773268952j),
            (2.9990052856246283 + 6.501266892735803j),
            (-1.213568255706268 - 7.8518152203006855j),
            (2.2563765121375905 - 2.0725204609870307j),
            (-5.130150683223966 + 1.9621289611210997j),
            (8.007816900398002 + 8.109832250191573e-16j),
            (-7.39736288308603 - 2.4672159839154073j),
            (-1.0551093731568175 - 2.2277803954555884j),
            (0.14499397144105108 + 3.9981034904921824j),
            (1.832269449963678 - 4.563720275807191j),
            (-2.2325171347303527 + 1.8152075258462763j),
            (0.2069349348360201 + 0.8176673720272915j),
            (-0.6051114070403474 - 1.5186178788798927j),
            (1.5566312625280698 + 3.0875033399097127j),
            (-2.696199386052085 - 5.850752415752731j),
            (-1.869175640511003 - 0.2448756587972366j),
            (3.6323740533734643 + 1.8621334348777738j),
            (-5.195762756320839 - 5.386925266040263j),
            (4.8597054431630005 + 9.376067095930924j),
            (-1.0535746129214343 + 1.7234897896656962j),
            (3.4110285118413612 - 2.6992315822282205j),
            (-7.397362883086037 + 2.4672159839154055j),
            (10.389601294360107 + 2.4702462297909733e-15j),
            (0.6445527230085164 + 0.7763490982051598j),
            (-0.696168470856375 - 2.078288881157189j),
            (-0.26283960662848216 + 3.677417043742026j),
            (1.9530935251112016 - 3.39674622912514j),
            (-1.427464925234378 + 0.00167268754300115j),
            (2.6610889213405233 + 1.0517470516143848j),
            (-4.019381030219863 - 3.267059899877601j),
            (4.996103682785603 + 6.2457676065531365j),
            (-0.6769669674005946 + 0.5354269929201221j),
            (1.239918934932036 - 0.36169504952710185j),
            (-1.4024319772032632 - 0.13193565010128383j),
            (0.4823894992589416 + 0.21097463166019237j),
            (0.4791579883727427 + 1.451327616132781j),
            (0.15534962847152037 - 2.2605116066807387j),
            (-1.0551093731568193 + 2.227780395455589j),
            (0.6445527230085175 - 0.7763490982051585j),
            (2.0802704300318906 + 3.1068163052776486e-16j),
            (-2.7181518910660567 - 1.1537127259352968j),
            (2.0874943786105793 + 2.1438456419139675j),
            (-0.3590111192880797 - 0.7751279645634738j),
            (0.23992080656208428 - 1.694208254828423j),
            (-1.069325251814369 + 1.755651624688092j),
            (1.1433940710198711 - 0.7871442082158803j),
            (0.9250810515885981 - 0.2912977121808745j),
            (0.5736703325027889 - 1.063828306081842j),
            (-1.4421392815336658 + 1.189890128578763j),
            (2.032081339000394 - 0.6458420494487609j),
            (-0.9169276531981672 - 0.052711085265592594j),
            (-1.4485132585653728 - 1.6383731023023775j),
            (1.1266534647433362 + 3.212512628314352j),
            (0.14499397144105397 - 3.998103490492183j),
            (-0.6961684708563787 + 2.078288881157189j),
            (-2.718151891066057 + 1.1537127259352955j),
            (4.452344697307424 + 1.4675760606763788e-15j),
            (-4.611542603493878 - 1.9358942647132371j),
            (1.7412710813248196 + 1.658770084652848j),
            (0.6253612439195001 + 2.1679765616088993j),
            (0.37591553066709255 - 2.870723703485572j),
            (-1.218767898650608 + 1.9241342206739551j),
            (-0.5130594790184129 + 0.6633590674366434j),
            (-0.07331881485169942 + 1.1316743631160544j),
            (0.8010921614343964 - 1.6524090857492415j),
            (-1.6292947037046663 + 1.4663918832958072j),
            (0.9196816812897857 - 0.3020279696736421j),
            (2.006111158001107 + 0.925631147072106j),
            (-2.5519569766075714 - 2.7184706523685835j),
            (1.832269449963676 + 4.563720275807192j),
            (-0.26283960662847583 - 3.677417043742024j),
            (2.0874943786105806 - 2.1438456419139653j),
            (-4.611542603493878 + 1.9358942647132331j),
            (6.559445178970877 + 2.6229018956769323e-15j),
            (-4.664205000513965 - 1.8452530210579243j),
            (-1.2853652110049358 - 1.5194958887597303j),
            (0.7819451884868546 + 2.785975445116888j),
            (0.5639693654831841 - 2.838386607397155j),
            (-0.7031673647315497 + 0.014702472595014227j),
            (-0.12199719034023782 + 0.05508958207667103j),
            (0.22856760264429005 + 0.07672004442254787j),
            (-0.25051487030944175 - 0.174105305204595j),
            (0.5206559215895525 - 0.30253773534663275j),
            (-0.5182636398408771 + 0.08651994917852632j),
            (1.3749613593928034 + 0.39140538000682207j),
            (-2.2325171347303545 - 1.8152075258462814j),
            (1.9530935251111958 + 3.3967462291251405j),
            (-0.359011119288082 + 0.7751279645634739j),
            (1.7412710813248213 - 1.6587700846528444j),
            (-4.66420500051397 + 1.8452530210579212j),
            (7.3622915312892045 + 3.1762786845135338e-15j),
            (0.014277711091810197 + 0.05322808683511726j),
            (-0.31877120649621676 - 0.7292841514874431j),
            (-0.05243419675924732 + 2.1141745707581223j),
            (1.6850716293954755 - 2.5820282895412014j),
            (0.2321617777209659 - 0.2338325771937968j),
            (-0.6992317822147703 + 0.05095725255557676j),
            (1.1288099576053716 + 0.7031144823949117j),
            (-0.8341953716758521 - 1.7350864043343435j),
            (-0.6158365355594886 + 0.01802579247902085j),
            (0.5896077716191513 + 0.4801133201516787j),
            (0.20693493483602016 - 0.817667372027293j),
            (-1.4274649252343783 - 0.001672687543000595j),
            (0.23992080656208306 + 1.694208254828423j),
            (0.6253612439195023 - 2.167976561608899j),
            (-1.285365211004939 + 1.5194958887597299j),
            (0.014277711091810974 - 0.053228086835115374j),
            (2.9912365326653996 + 9.490053134050935e-16j),
            (-3.751954739275282 - 1.5942477593170903j),
            (2.822131188690556 + 2.8026898745375473j),
            (-0.7813580567970035 - 0.9628729513404714j),
            (-0.557198228644628 + 0.3783360559626206j),
            (1.5102266479625435 - 0.16056005789134659j),
            (-2.692854543033304 - 0.9823712946386942j),
            (2.9222967230268377 + 2.843401691005984j),
            (0.5364305636982343 + 0.004950035491432997j),
            (-0.49480166257529123 - 0.7089133265424161j),
            (-0.6051114070403474 + 1.5186178788798952j),
            (2.6610889213405233 - 1.0517470516143859j),
            (-1.0693252518143677 - 1.755651624688093j),
            (0.3759155306670895 + 2.8707237034855715j),
            (0.7819451884868598 - 2.7859754451168874j),
            (-0.31877120649622076 + 0.7292841514874426j),
            (-3.751954739275283 + 1.5942477593170867j),
            (6.103931674548608 + 2.7478019859472624e-15j),
            (-6.486416224993923 - 2.614802947319646j),
            (3.3015097812527787 + 2.532178058528284j),
            (1.185631638488276 - 0.7663533801993496j),
            (-2.916039965157127 + 0.6312160791953422j),
            (5.339665846712012 + 0.7304753004301764j),
            (-6.7880990432731245 - 3.3011111546990346j),
            (-0.2881659363134894 - 0.7103399324688049j),
            (-0.07512102369069212 + 1.7709098019915004j),
            (1.5566312625280705 - 3.0875033399097136j),
            (-4.019381030219862 + 3.267059899877605j),
            (1.1433940710198711 + 0.7871442082158819j),
            (-1.218767898650604 - 1.9241342206739551j),
            (0.5639693654831803 + 2.8383866073971586j),
            (-0.05243419675923994 - 2.11417457075812j),
            (2.8221311886905585 - 2.8026898745375437j),
            (-6.486416224993923 + 2.614802947319639j),
            (9.989504427757238 + 4.801714581503802e-15j),
            (-9.095705527977323 - 3.1096727455332345j),
            (-1.7923587436194286 + 1.4249208389189998j),
            (4.30125549000658 - 1.5848803551063384j),
            (-8.00210813200191 + 0.46987716356627224j),
            (11.099678261564822 + 2.05599107496877j),
            (0.45904890845352125 + 2.2135170695238062j),
            (0.5265173468929134 - 4.0659999271377085j),
            (-2.696199386052086 + 5.85075241575273j),
            (4.996103682785603 - 6.245767606553132j),
            (0.9250810515885977 + 0.29129771218087425j),
            (-0.5130594790184126 - 0.6633590674366436j),
            (-0.7031673647315513 - 0.01470247259501728j),
            (1.6850716293954746 + 2.582028289541202j),
            (-0.7813580567970065 + 0.9628729513404714j),
            (3.301509781252781 - 2.532178058528281j),
            (-9.09570552797733 + 3.1096727455332305j),
            (15.615916224079962 + 2.4667767828390197e-15j),
        ]
    )

    hafs = hermite_multidimensional(mat, d, 4, renorm=False)

    assert np.allclose(hafs, expected)
